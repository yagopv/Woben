define(["durandal/system","knockout"],function(e,t){function r(e){return void 0==e&&(e={}),e.closeOnDeactivate||(e.closeOnDeactivate=c.defaults.closeOnDeactivate),e.beforeActivate||(e.beforeActivate=c.defaults.beforeActivate),e.afterDeactivate||(e.afterDeactivate=c.defaults.afterDeactivate),e.affirmations||(e.affirmations=c.defaults.affirmations),e.interpretResponse||(e.interpretResponse=c.defaults.interpretResponse),e.areSameItem||(e.areSameItem=c.defaults.areSameItem),e}function n(t,r,n){return e.isArray(n)?t[r].apply(t,n):t[r](n)}function a(t,r,n,a,i){if(t&&t.deactivate){e.log("Deactivating",t);var o;try{o=t.deactivate(r)}catch(s){return e.error(s),a.resolve(!1),void 0}o&&o.then?o.then(function(){n.afterDeactivate(t,r,i),a.resolve(!0)},function(t){e.log(t),a.resolve(!1)}):(n.afterDeactivate(t,r,i),a.resolve(!0))}else t&&n.afterDeactivate(t,r,i),a.resolve(!0)}function i(t,r,a,i){if(t)if(t.activate){e.log("Activating",t);var o;try{o=n(t,"activate",i)}catch(s){return e.error(s),a(!1),void 0}o&&o.then?o.then(function(){r(t),a(!0)},function(t){e.log(t),a(!1)}):(r(t),a(!0))}else r(t),a(!0);else a(!0)}function o(t,r,n){return n.lifecycleData=null,e.defer(function(a){if(t&&t.canDeactivate){var i;try{i=t.canDeactivate(r)}catch(o){return e.error(o),a.resolve(!1),void 0}i.then?i.then(function(e){n.lifecycleData=e,a.resolve(n.interpretResponse(e))},function(t){e.error(t),a.resolve(!1)}):(n.lifecycleData=i,a.resolve(n.interpretResponse(i)))}else a.resolve(!0)}).promise()}function s(t,r,a,i){return a.lifecycleData=null,e.defer(function(o){if(t==r())return o.resolve(!0),void 0;if(t&&t.canActivate){var s;try{s=n(t,"canActivate",i)}catch(l){return e.error(l),o.resolve(!1),void 0}s.then?s.then(function(e){a.lifecycleData=e,o.resolve(a.interpretResponse(e))},function(t){e.error(t),o.resolve(!1)}):(a.lifecycleData=s,o.resolve(a.interpretResponse(s)))}else o.resolve(!0)}).promise()}function l(n,l){var c,u=t.observable(null);l=r(l);var d=t.computed({read:function(){return u()},write:function(e){d.viaSetter=!0,d.activateItem(e)}});return d.__activator__=!0,d.settings=l,l.activator=d,d.isActivating=t.observable(!1),d.canDeactivateItem=function(e,t){return o(e,t,l)},d.deactivateItem=function(t,r){return e.defer(function(e){d.canDeactivateItem(t,r).then(function(n){n?a(t,r,l,e,u):(d.notifySubscribers(),e.resolve(!1))})}).promise()},d.canActivateItem=function(e,t){return s(e,u,l,t)},d.activateItem=function(t,r){var n=d.viaSetter;return d.viaSetter=!1,e.defer(function(o){if(d.isActivating())return o.resolve(!1),void 0;d.isActivating(!0);var s=u();return l.areSameItem(s,t,c,r)?(d.isActivating(!1),o.resolve(!0),void 0):(d.canDeactivateItem(s,l.closeOnDeactivate).then(function(f){f?d.canActivateItem(t,r).then(function(f){f?e.defer(function(e){a(s,l.closeOnDeactivate,l,e)}).promise().then(function(){t=l.beforeActivate(t,r),i(t,u,function(e){c=r,d.isActivating(!1),o.resolve(e)},r)}):(n&&d.notifySubscribers(),d.isActivating(!1),o.resolve(!1))}):(n&&d.notifySubscribers(),d.isActivating(!1),o.resolve(!1))}),void 0)}).promise()},d.canActivate=function(){var e;return n?(e=n,n=!1):e=d(),d.canActivateItem(e)},d.activate=function(){var e;return n?(e=n,n=!1):e=d(),d.activateItem(e)},d.canDeactivate=function(e){return d.canDeactivateItem(d(),e)},d.deactivate=function(e){return d.deactivateItem(d(),e)},d.includeIn=function(e){e.canActivate=function(){return d.canActivate()},e.activate=function(){return d.activate()},e.canDeactivate=function(e){return d.canDeactivate(e)},e.deactivate=function(e){return d.deactivate(e)}},l.includeIn?d.includeIn(l.includeIn):n&&d.activate(),d.forItems=function(t){l.closeOnDeactivate=!1,l.determineNextItemToActivate=function(e,t){var r=t-1;return-1==r&&e.length>1?e[1]:r>-1&&r<e.length-1?e[r]:null},l.beforeActivate=function(e){var r=d();if(e){var n=t.indexOf(e);-1==n?t.push(e):e=t()[n]}else e=l.determineNextItemToActivate(t,r?t.indexOf(r):0);return e},l.afterDeactivate=function(e,r){r&&t.remove(e)};var r=d.canDeactivate;d.canDeactivate=function(n){return n?e.defer(function(e){function r(){for(var t=0;t<i.length;t++)if(!i[t])return e.resolve(!1),void 0;e.resolve(!0)}for(var a=t(),i=[],o=0;o<a.length;o++)d.canDeactivateItem(a[o],n).then(function(e){i.push(e),i.length==a.length&&r()})}).promise():r()};var n=d.deactivate;return d.deactivate=function(r){return r?e.defer(function(e){function n(n){d.deactivateItem(n,r).then(function(){i++,t.remove(n),i==o&&e.resolve()})}for(var a=t(),i=0,o=a.length,s=0;o>s;s++)n(a[s])}).promise():n()},d},d}var c,u={closeOnDeactivate:!0,affirmations:["yes","ok","true"],interpretResponse:function(r){return e.isObject(r)&&(r=r.can||!1),e.isString(r)?-1!==t.utils.arrayIndexOf(this.affirmations,r.toLowerCase()):r},areSameItem:function(e,t){return e==t},beforeActivate:function(e){return e},afterDeactivate:function(e,t,r){t&&r&&r(null)}};return c={defaults:u,create:l,isActivator:function(e){return e&&e.__activator__}}});