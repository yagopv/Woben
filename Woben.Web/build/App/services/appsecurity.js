define(["durandal/system","durandal/app","plugins/router","services/routeconfig","services/utils","services/logger"],function(e,t,n,r,a,i){function o(e,t){return"/api/account/externalLogins?returnUrl="+encodeURIComponent(e)+"&generateState="+(t?"true":"false")}function s(e,t){return"/api/account/manageinfo?returnUrl="+encodeURIComponent(e)+"&generateState="+(t?"true":"false")}function l(){var e=sessionStorage.accessToken||localStorage.accessToken;return e?{Authorization:"Bearer "+e}:{}}function c(){return 0===window.location.hash.indexOf("#")?d(window.location.hash.substr(1)):{}}function d(e){var t,n,r,a,i,o,s,l={};if(null===e)return l;t=e.split("&");for(var c=0;c<t.length;c++)n=t[c],r=n.indexOf("="),-1===r?(a=n,i=null):(a=n.substr(0,r),i=n.substr(r+1)),o=decodeURIComponent(a),s=decodeURIComponent(i),l[o]=s;return l}function u(){localStorage.removeItem("accessToken"),sessionStorage.removeItem("accessToken")}function f(e,t){t?localStorage.accessToken=e:sessionStorage.accessToken=e}function h(e){var t;"undefined"!=typeof e.access_token&&(t=sessionStorage.state,sessionStorage.removeItem("state"),(null===t||e.state!==t)&&(e.error="invalid_state"))}function v(){window.location.hash="",history&&"undefined"!=typeof history.pushState&&history.pushState("",document.title,location.pathname)}function p(){for(var e={},t=0;t<sessionStorage.length;t++)e[sessionStorage.key(t)]=sessionStorage[sessionStorage.key(t)];localStorage.sessionStorageBackup=JSON.stringify(e),sessionStorage.clear()}function g(){var e,t=localStorage.sessionStorageBackup;if(t){e=JSON.parse(t);for(var n in e)sessionStorage[n]=e[n];localStorage.removeItem("sessionStorageBackup")}}function m(e,t,n){this.name=ko.observable(e),this.roles=ko.observableArray(t),this.isEmailConfirmed=ko.observable(n)}function b(){$(document).off("click","#sendConfirmationMail"),$(document).on("click","#sendConfirmationMail",function(){w().then(function(e,t){i.logSuccess("Email sent. Please check your inbox and confirm your account",t,null,!0)}).fail(function(e,t,n){i.logError(n,t,null,!0)})})}function w(){return $.ajax(r.resendMailRoute,{type:"POST",headers:l()})}return{userInfo:ko.observable(),setAuthInfo:function(e,t,n,r,a){var i=this;r&&f(r,a),"string"==typeof t&&(t=t.split(",")),i.userInfo(new m(e,t,n)),0==n&&i.showConfirmationWarning(!1)},showConfirmationWarning:function(e){i.showAccountWarning(e),b()},clearAuthInfo:function(){var e=this;u(),e.userInfo(void 0)},isUserInRole:function(e){var t=this,n=!1;return $.each(e,function(e,r){-1!==t.userInfo().roles.indexOf(r)&&(n=!0)}),n},getSecurityHeaders:l,archiveSessionStorageToLocalStorage:p,returnUrl:r.siteUrl,addExternalLogin:function(e){return $.ajax(r.addExternalLoginUrl,{type:"POST",data:e,headers:l()})},changePassword:function(e){return $.ajax(r.changePasswordUrl,{type:"POST",data:e,headers:l()})},getExternalLogins:function(e,t){return $.ajax(o(e,t),{cache:!1,headers:l()})},getManageInfo:function(e,t){return $.ajax(s(e,t),{cache:!1,headers:l()})},getUserInfo:function(e){var t;return t="undefined"!=typeof e?{Authorization:"Bearer "+e}:l(),$.ajax(r.userInfoUrl,{cache:!1,headers:t})},login:function(e){return $.ajax(r.loginUrl,{type:"POST",data:e})},logout:function(){return $.ajax(r.logoutUrl,{type:"POST",headers:l()})},register:function(e){return $.ajax(r.registerUrl,{type:"POST",data:e})},registerExternal:function(e,t){return $.ajax(r.registerExternalUrl,{type:"POST",data:t,headers:{Authorization:"Bearer "+e}})},removeLogin:function(e){return $.ajax(r.removeLoginUrl,{type:"POST",data:e,headers:l()})},setPassword:function(e){return $.ajax(r.setPasswordUrl,{type:"POST",data:e,headers:l()})},getUsers:function(){return $.ajax(r.getUsersUrl,{type:"GET",headers:l()})},forgotPassword:function(e){return $.ajax(r.forgotPassword,{type:"POST",data:e,cache:!1,headers:l()})},resetPassword:function(e){return $.ajax(r.resetPassword,{type:"POST",data:e,cache:!1,headers:l()})},deleteAccount:function(){return $.ajax(r.deleteaccount,{type:"POST",cache:!1,headers:l()})},initializeAuth:function(){var t=this;return e.defer(function(e){var n,r,a,i=c();g(),h(i),sessionStorage.associatingExternalLogin?(sessionStorage.removeItem("associatingExternalLogin"),"undefined"!=typeof i.error?(n=null,r=i.error,v()):"undefined"!=typeof i.access_token?(n=i.access_token,r=null,v()):(n=null,r=null,v()),t.getUserInfo().done(function(a){a.userName&&(t.setAuthInfo(a.userName,a.roles,a.isEmailConfirmed),sessionStorage.redirectTo="account/manage?externalAccessToken="+n+"&externalError="+r),e.resolve(!0)}).fail(function(){e.resolve(!0)})):"undefined"!=typeof i.error?(v(),sessionStorage.redirectTo="account/externalloginfailure",e.resolve(!0)):"undefined"!=typeof i.access_token?(v(),t.getUserInfo(i.access_token).done(function(n){"undefined"!=typeof n.userName&&"undefined"!=typeof n.hasRegistered&&"undefined"!=typeof n.loginProvider?n.hasRegistered?(t.setAuthInfo(n.userName,n.roles,n.isEmailConfirmed,i.access_token,!1),e.resolve(!0)):"undefined"!=typeof sessionStorage.loginUrl?(a=sessionStorage.loginUrl,sessionStorage.removeItem("loginUrl"),sessionStorage.redirectTo="account/externalloginconfirmation?userName="+n.userName+"&loginProvider="+n.loginProvider+"&access_token="+i.access_token+"&loginUrl="+encodeURIComponent(a)+"&state="+i.state,e.resolve(!0)):e.resolve(!0):e.resolve(!0)}).fail(function(){e.resolve(!0)})):sessionStorage.accessToken||localStorage.accessToken?t.getUserInfo().done(function(n){n.userName&&t.setAuthInfo(n.userName,n.roles,n.isEmailConfirmed),e.resolve(!0)}).fail(function(){e.resolve(!0)}):e.resolve(!0)}).promise()}}});