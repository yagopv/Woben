define(["services/unitofwork","services/errorhandler","services/logger","services/utils"],function(e,t,r,n){function a(e,t){for(var r=0;r<t().length;r++)if(e==t()[r].name())return t()[r]}function i(e){$("#tags").tagsInput({onAddTag:function(t){e().addTag(t)},onRemoveTag:function(t){e().deleteTag(a(t,e().tags))},defaultText:"New tag"})}var e=e.create(),o={categories:ko.observableArray(),selectedArticle:ko.observable(),articles:ko.observableArray(),updating:ko.observable(!1),preview:ko.observable(!1),activate:function(){ga("send","pageview",{page:window.location.href,title:document.title})},attached:function(){var t=this;Stashy.FocalPoint("#dashboard img").on(),$("#dashboard #edited-article").on("hide.bs.modal",function(){t.selectedArticle().entityAspect.hasValidationErrors&&(ko.validation.group(t.selectedArticle()),t.selectedArticle().errors.showAllMessages()),t.selectedArticle().unsavedChanges(t.selectedArticle().entityAspect.entityState.isAddedModifiedOrDeleted())}),Stashy.ShowMeMore("#dashboard-articles .row",{linkClass:"btn btn-primary",linkText:"Show more articles",howMany:4}).on(),$("#dashboard #edited-article").on("shown.bs.modal",function(){$("#dashboard #edited-article .zen-mode").zenForm({trigger:"#dashboard #edited-article .go-zen"}),$("#dashboard #edited-article .zen-mode").keyup()}),$("#dashboard #edited-article").on("zf-destroyed",function(){$("#dashboard #edited-article .zen-mode").trigger("change")});var r=e.privatearticles.all().then(function(e){t.articles(e)}),n=e.categories.all().then(function(e){t.categories(e)});Q.all([r,n]).fail(t.handleError)},newArticle:function(){var t=this,r=e.privatearticles.create({categoryId:this.categories()[0].categoryId()});this.articles.unshift(r),this.selectedArticle(r),i(t.selectedArticle),this.updating(!1),$("#edited-article").modal("show")},editArticle:function(e){var t=this;this.selectedArticle(e),i(t.selectedArticle),this.updating(!0),$("#edited-article").modal("show")},saveArticles:function(){var t=this;return e.hasChanges()?(e.commit().then(function(){r.logSuccess("Article saved succesfully",null,null,!0),ko.utils.arrayForEach(t.articles(),function(e){e.unsavedChanges(e.entityAspect.entityState.isAddedModifiedOrDeleted())})}).fail(this.handleError),!0):!0},deleteArticle:function(t,n,a){var i=this;ko.utils.arrayForEach(t.tags(),function(){t.deleteTag(t.tags()[0])}),e.privatearticles.delete(t),e.commit().then(function(){n.articles.remove(t),r.logSuccess("Article removed succesfully",null,null,!0),a&&$("#edited-article").modal("hide")}).fail(i.handleError)},closeModal:function(){$("#edited-article").modal("hide")},changePreview:function(e,t){t.preview()?t.preview(!1):t.preview(!0)},convertMarkdown:function(e){e.html(marked(e.markdown()))},utils:n};return t.includeIn(o),o});