define(["durandal/system","services/appsecurity","services/errorhandler","services/logger","services/utils","durandal/app","plugins/router"],function(e,t,r,n,a,i){function o(e){var r=this;r.name=ko.observable(e.name),r.login=function(){sessionStorage.state=e.state,sessionStorage.associatingExternalLogin=!0,t.archiveSessionStorageToLocalStorage(),window.location=e.url},r.socialIcon=function(e){var t="";switch(e.name().toLowerCase()){case"facebook":t="fa fa-facebook-square";break;case"twitter":t="fa fa-twitter-square";break;case"google":t="fa fa-google-plus-square";break;case"microsoft":t="fa fa-envelope";break;default:t="fa fa-check-square"}return t}}function s(e){function a(){i.oldPassword(null),i.newPassword(null),i.confirmPassword(null),i.changing(!1),i.validationErrors.showAllMessages(!1)}var i=this;i.name=ko.observable(e),i.oldPassword=ko.observable("").extend({required:!0}),i.newPassword=ko.observable("").extend({required:!0}),i.confirmPassword=ko.observable("").extend({required:!0,equal:i.newPassword}),i.changing=ko.observable(!1),i.validationErrors=ko.validation.group([i.oldPassword,i.newPassword,i.confirmPassword]),r.includeIn(i),i.change=function(){return i.validationErrors().length>0?(i.validationErrors.showAllMessages(),void 0):(i.changing(!0),t.changePassword({oldPassword:i.oldPassword(),newPassword:i.newPassword(),confirmPassword:i.confirmPassword()}).done(function(){i.changing(!1),a(),n.logSuccess("Password changed",null,null,!0)}).fail(i.handlevalidationerrors).fail(function(){i.changing(!1)}),void 0)}}function l(e,a){var i=this,o=ko.observable(e.providerKey);i.loginProvider=ko.observable(e.loginProvider),i.removing=ko.observable(!1),r.includeIn(i),i.remove=function(){var e=this;e.removing(!0),t.removeLogin({loginProvider:e.loginProvider(),providerKey:o()}).done(function(){e.removing(!1),a.remove(e),n.logSuccess("Login removed succesfully",null,null,!0)}).fail(e.handlevalidationerrors).fail(function(){e.removing(!1)})}}function c(e,a,i){var o=this;o.newPassword=ko.observable("").extend({required:!0}),o.confirmPassword=ko.observable("").extend({required:!0,equal:o.newPassword}),o.setting=ko.observable(!1),o.validationErrors=ko.validation.group([o.newPassword,o.confirmPassword]),o.set=function(){var o=this;return o.validationErrors().length>0?(o.validationErrors.showAllMessages(),void 0):(o.setting(!0),r.includeIn(o),t.setPassword({newPassword:o.newPassword(),confirmPassword:o.confirmPassword()}).done(function(){o.setting(!1),e.push(new l({loginProvider:a(),providerKey:i()},e)),n.logSuccess("Password set successfully",null,null,!0)}).fail(o.handlevalidationerrors).fail(function(){o.setting(!1)}),void 0)}}var u,d,f=ko.observable(),h=ko.observableArray(),v=ko.observableArray(),g=ko.observable(),p=ko.computed(function(){for(var e=h(),t=0;t<e.length;t++)if(e[t].loginProvider()===g())return!0;return!1}),m=ko.computed(function(){return v().length>0}),m=ko.computed(function(){return v().length>0}),b=ko.computed(function(){return h().length>1}),w={userName:f,localLoginProvider:g,addExternalLogin:function(r,a){var i=this;return e.defer(function(e){"null"!==a||null===r?(n.logError("External login error",null,null,!0),e.resolve()):t.addExternalLogin({externalAccessToken:r}).done(function(){e.resolve()}).fail(function(t){i.handleauthenticationerrors(t),e.resolve()})})},userLogins:h,hasLocalPassword:p,externalLoginProviders:v,loading:ko.observable(!0),message:ko.observable(),changePassword:new s(f()),setPassword:new c(h,g,f),hasExternalLogin:m,canRemoveLogin:b,initialize:function(){var e=this;t.getManageInfo(t.returnUrl,!0).done(function(t){if("undefined"!=typeof t.localLoginProvider&&"undefined"!=typeof t.userName&&"undefined"!=typeof t.logins&&"undefined"!=typeof t.externalLoginProviders){e.userName(t.userName),e.localLoginProvider(t.localLoginProvider),e.userLogins.removeAll();for(var r=0;r<t.logins.length;r++)e.userLogins.push(new l(t.logins[r],e.userLogins));e.externalLoginProviders.removeAll();for(var r=0;r<t.externalLoginProviders.length;r++)e.externalLoginProviders.push(new o(t.externalLoginProviders[r]))}else n.logError("Error retrieving user account information",null,null,!0);e.loading(!1)}).fail(e.handlevalidationerrors).fail(function(){e.loading(!1)})},activate:function(){var e=this;return ga("send","pageview",{page:window.location.href,title:document.title}),u=a.getUrlParameter("externalAccessToken"),d=a.getUrlParameter("externalError"),"null"===u&&"null"===d?e.initialize():(e.addExternalLogin(u,d).done(function(){return e.initialize()}),void 0)},deleteAccount:function(){var e=this;return i.showMessage("The account will be removed permanently","Are you sure?",["Yes","No"]).then(function(r){"Yes"===r&&t.deleteAccount().done(function(){t.logout().done(function(){t.clearAuthInfo(),window.location="/account/login"}).fail(e.handlevalidationerrors)}).fail(e.handlevalidationerrors)})}};return r.includeIn(w),w});