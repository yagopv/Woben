define(["services/appsecurity","plugins/router","services/errorhandler"],function(e,t,r){function n(t,r){var n=this;n.name=ko.observable(t.name),n.login=function(){sessionStorage.state=t.state,sessionStorage.loginUrl=t.url,sessionStorage.redirectTo=r?r:"account/manage",e.archiveSessionStorageToLocalStorage(),window.location=t.url},n.socialIcon=function(e){var t="";switch(e.name().toLowerCase()){case"facebook":t="fa fa-facebook-square";break;case"twitter":t="fa fa-twitter-square";break;case"google":t="fa fa-google-plus-square";break;case"microsoft":t="fa fa-envelope";break;default:t="fa fa-check-square"}return t}}var a=ko.observable().extend({required:!0}),i=ko.observable().extend({required:!0,minLength:6}),o=ko.observable(!1),s=ko.observable(null);ko.observable(!1);var l={convertRouteToHash:t.convertRouteToHash,username:a,password:i,rememberMe:o,returnUrl:s,appsecurity:e,externalLoginProviders:ko.observableArray(),activate:function(t){var r=this;return ga("send","pageview",{page:window.location.href,title:document.title}),t&&t.returnUrl&&r.returnUrl(t.returnUrl),e.getExternalLogins(e.returnUrl,!0).then(function(e){if("object"==typeof e){r.externalLoginProviders.removeAll();for(var t=0;t<e.length;t++)r.externalLoginProviders.push(new n(e[t],r.returnUrl()?r.returnUrl():null))}}).fail(r.handleauthenticationerrors)},login:function(){var r=this;return 0!=this.errors().length?(this.errors.showAllMessages(),void 0):(e.login({grant_type:"password",username:r.username(),password:r.password()}).done(function(n){if(n.userName&&n.access_token){e.setAuthInfo(n.userName,n.roles,"true"==n.emailConfirmed?!0:!1,n.access_token,r.rememberMe());var a=breeze.config.getAdapterInstance("ajax");a.defaultSettings={headers:e.getSecurityHeaders()},r.username(""),r.password(""),r.rememberMe(!1),r.errors.showAllMessages(!1),r.returnUrl()?t.navigate(r.returnUrl()):t.navigate("account/manage")}}).fail(r.handleauthenticationerrors),void 0)},logout:function(){e.logout()}};return r.includeIn(l),l.errors=ko.validation.group(l),l});